#!/bin/bash -e
# Interactively remove a peer from a WireGuard configuration
# This script is build for systemd-networkd's netdev-files,
# but should be easily convertible for wg-quick
#   created by Eicke Herbertz, 2020

remove_peer() {
    local peer="$1"

    # Always print portion that is removed to stdout
    if gawk -v pk="${peer}" \
        '{ l[++n]=$0 }
        /^PublicKey/ { if($3==pk){ f=1;fs=1 } }
        /^$/ { if(f){ for(i=1;i<=n;i++){ print l[i] } } delete l;n=0;f=0 }
        END { exit !fs }' \
        ${NETDEV}
    then
        if [[ "${YES}" != "yes" ]]; then
            echo -n "Remove this configuration from ${NETDEV}? [y/N] "
            read del
            [[ "${del}" == "y" || "${del}" == "Y" ]] || return 1
        fi

        # Remove from $NETDEV
        gawk -i inplace -v pk="${peer}" \
            '{ l[++n]=$0 }
            /^PublicKey/ { if($3==pk){ f=1;fs=1 } }
            /^$/ { if(!f){ for(i=1;i<=n;i++){ print l[i] } } delete l;n=0;f=0 }
            END { exit !fs }' \
            ${NETDEV}

        # Find interface in $NETDEV
        local interface=$(awk '/Name = /{print $3}' ${NETDEV})

        # Check if interface is non-zero and actually existing
        if [[ ${INTERFACE} && -e /sys/class/net/${INTERFACE} ]]; then
            wg set ${INTERFACE} peer "${peer}" remove
        fi
        return 0
    else
        echo "No peer with this PublicKey was found!" >&2
        return 1
    fi
}

usage() {
    echo "Usage: remove-wg-peer [-y] [-f <file>] [public-key]"
    echo "    -f <file>   systemd .netdev file to edit"
    echo "    -y          no confirmation required"
    echo "    public-key  the PublicKey of the peer to remove"
    echo "  Without peer passed, PublicKey will be queried interactively."
    exit $1
}

if [[ $UID -ne 0 && ! $WG_TEST ]]; then
    echo "Privilege elevation..." >&2
    sudo $0 $@
    exit $?
fi

# use enhanced getopt
OPTS=f:yh
LOPTS=file:,noconfirm,help
PARSED_OPTS=$(getopt -o $OPTS -l $LOPTS -n "$0" -- "$@")
eval set -- "$PARSED_OPTS"

# set defaults
DEFAULT_NETDEV=${WG_TEST_FILE:-$(ls /etc/systemd/network/*.netdev | \
                                 grep -E 'wg|wireguard' | head -1)}
NETDEV=${DEFAULT_NETDEV}
YES=n

while [[ "$1" != "--" ]]; do
    case $1 in
    -f|--file)
        NETDEV="$2"
        shift 2
        ;;
    -y|--noconfirm)
        YES=yes
        shift
        ;;
    -h|--help)
        usage
        ;;
    *)
        echo "Programming error" >&2
        exit 1
        ;;
    esac
done

# $1 is --, $2 is peer
if [[ $# -gt 2 ]]; then
    echo "Error: Too many arguments!" >&2
    usage 1
fi
PEER=$2

# go interactive if no peer provided
if [[ -z "${PEER}" ]]; then
    echo "Remove WireGuard peer(s) from ${NETDEV}"

    cont="y"
    while [[ "${cont}" == "y" || "${cont}" == "Y" ]]; do
        echo -n "Enter PublicKey: "
        read peer
        ! remove_peer "${peer}" 2>&1
        echo -n "Remove another peer? [y/N] "
        read cont
    done
else
    remove_peer "${PEER}"
fi
